<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="A general case of iterative proportional fitting. It can satisfy
two, disparate sets of marginals that do not agree on a single total. A
common example is balancing population data using household- and person-level
marginal controls. This could be for survey expansion or synthetic
population creation. The second set of marginal/seed data is optional, meaning
it can also be used for more basic IPF tasks.
This is the same function as provided by the ipfr package but updated so the output
also includes information weather the algorithm converged."><title>Iterative Proportional Updating — ipu2 • ssid</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Iterative Proportional Updating — ipu2"><meta property="og:description" content="A general case of iterative proportional fitting. It can satisfy
two, disparate sets of marginals that do not agree on a single total. A
common example is balancing population data using household- and person-level
marginal controls. This could be for survey expansion or synthetic
population creation. The second set of marginal/seed data is optional, meaning
it can also be used for more basic IPF tasks.
This is the same function as provided by the ipfr package but updated so the output
also includes information weather the algorithm converged."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ssid</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Introduction.html">Introduction</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/michielvandijk/ssid/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Iterative Proportional Updating</h1>
      <small class="dont-index">Source: <a href="https://github.com/michielvandijk/ssid/blob/HEAD/R/ipu2.R" class="external-link"><code>R/ipu2.R</code></a></small>
      <div class="d-none name"><code>ipu2.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A general case of iterative proportional fitting. It can satisfy
two, disparate sets of marginals that do not agree on a single total. A
common example is balancing population data using household- and person-level
marginal controls. This could be for survey expansion or synthetic
population creation. The second set of marginal/seed data is optional, meaning
it can also be used for more basic IPF tasks.</p>
<p>This is the same function as provided by the ipfr package but updated so the output
also includes information weather the algorithm converged.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ipu2</span><span class="op">(</span></span>
<span>  <span class="va">primary_seed</span>,</span>
<span>  <span class="va">primary_targets</span>,</span>
<span>  secondary_seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  secondary_targets <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  primary_id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  secondary_importance <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  relative_gap <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  max_iterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  absolute_diff <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  weight_floor <span class="op">=</span> <span class="fl">1e-05</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  max_ratio <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  min_ratio <span class="op">=</span> <span class="fl">1e-04</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>primary_seed</dt>
<dd><p>In population synthesis or household survey expansion,
this would be the household seed table (each record would represent a
household). It could also be a trip table, where each row represents an
origin-destination pair.</p></dd>


<dt>primary_targets</dt>
<dd><p>A <code>named list</code> of data frames.  Each name in the
list defines a marginal dimension and must match a column from the
<code>primary_seed</code> table. The data frame associated with each named list
element can contain a geography field (starting with "geo_"). If so, each
row in the target table defines a new geography (these could be TAZs,
tracts, clusters, etc.). The other column names define the marginal
categories that targets are provided for. The vignette provides more
detail.</p></dd>


<dt>secondary_seed</dt>
<dd><p>Most commonly, if the primary_seed describes
households, the secondary seed table would describe the persons in each
household. Must contain the same <code>primary_id</code> column that links each
person to their respective household in <code>primary_seed</code>.</p></dd>


<dt>secondary_targets</dt>
<dd><p>Same format as <code>primary_targets</code>, but they constrain
the <code>secondary_seed</code> table.</p></dd>


<dt>primary_id</dt>
<dd><p>The field used to join the primary and secondary seed
tables. Only necessary if <code>secondary_seed</code> is provided.</p></dd>


<dt>secondary_importance</dt>
<dd><p>A <code>real</code> between 0 and 1 signifying the
importance of the secondary targets. At an importance of 1, the function
will try to match the secondary targets exactly. At 0, only the percentage
distributions are used (see the vignette section "Target Agreement".)</p></dd>


<dt>relative_gap</dt>
<dd><p>After each iteration, the weights are compared to the
previous weights and the %RMSE is calculated. If the %RMSE is less than
the <code>relative_gap</code> threshold, then the process terminates.</p></dd>


<dt>max_iterations</dt>
<dd><p>maximum number of iterations to perform, even if
<code>relative_gap</code> is not reached.</p></dd>


<dt>absolute_diff</dt>
<dd><p>Upon completion, the <code>ipu()</code> function will report
the worst-performing marginal category and geography based on the percent
difference from the target. <code>absolute_diff</code> is a threshold below which
percent differences don't matter.</p>
<p>For example, if if a target value was 2, and the expanded weights equaled
1, that's a 100% difference, but is not important because the absolute value
is only 1.</p>
<p>Defaults to 10.</p></dd>


<dt>weight_floor</dt>
<dd><p>Minimum weight to allow in any cell to prevent zero
weights. Set to .0001 by default.  Should be arbitrarily small compared to
your seed table weights.</p></dd>


<dt>verbose</dt>
<dd><p>Print iteration details and worst marginal stats upon
completion? Default <code>FALSE</code>.</p></dd>


<dt>max_ratio</dt>
<dd><p><code>real</code> number. The average weight per seed record is
calculated by dividing the total of the targets by the number of records.
The max_scale caps the maximum weight at a multiple of that average. Defaults
to <code>10000</code> (basically turned off).</p></dd>


<dt>min_ratio</dt>
<dd><p><code>real</code> number. The average weight per seed record is
calculated by dividing the total of the targets by the number of records.
The min_scale caps the minimum weight at a multiple of that average. Defaults
to <code>0.0001</code> (basically turned off).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>a <code>named list</code> with the <code>primary_seed</code> with weight, a
histogram of the weight distribution, and two comparison tables to aid in
reporting.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.537.723&amp;rep=rep1&amp;type=pdf" class="external-link">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.537.723&amp;rep=rep1&amp;type=pdf</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">hh_seed</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  siz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  geo_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">hh_targets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">hh_targets</span><span class="op">$</span><span class="va">siz</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  geo_cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  `1` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  `2` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">150</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">ipu</span><span class="op">(</span><span class="va">hh_seed</span>, <span class="va">hh_targets</span>, max_iterations <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in ipu(hh_seed, hh_targets, max_iterations = 5):</span> could not find function "ipu"</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

